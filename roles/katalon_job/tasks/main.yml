---
- name: Create Katalon Config Job Template
  copy:
    content: "{{ config }}"
    dest: /home/coe/jobs/ansible-config.yaml

- name: Create Katalon Config Job Template
  copy:
    content: "{{ job }}"
    dest: /home/coe/jobs/ansible-job.yaml

- name: Apply Katalon Job
  shell: |
    echo {{ item | quote }} | {{ kubectl_cmd }} apply -f -
  with_items:
    - "{{ config }}"
    - "{{ job }}"
  no_log: false

- name: Get Katalon Job Information
  shell: kubectl describe pods -n {{ kubernetes_namespace }} | gsed -n '/^Containers/,/Conditions/p' | grep Reason | awk '{split($0,a," "); print a[2]}'
  register: pod_state
  no_log: false

- name: Get logs
  shell: kubectl logs job/katalonstudio -n {{ kubernetes_namespace }} | gsed -n '/<?xml/,/testsuites>/p' >> junit.xml
  until: pod_state == "Completed"
  retries: 3
  delay: 60

- name: Delete job & pod
  shell: kubectl delete job -l name={{ job_name }} -n {{ kubernetes_namespace }}
